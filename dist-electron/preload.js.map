{"version":3,"file":"preload.js","sources":["../electron/utils.ts","../electron/preload.ts"],"sourcesContent":["import { app } from 'electron';\r\nconst iconv = require('iconv-lite'); \r\nimport path from 'path';\r\nimport fs from 'fs';\r\n\r\n// 工具函数\r\nexport function convertUrlToPath(url: string): string {\r\n  const path = require('path');\r\n  const fs = require('fs');\r\n  \r\n  // 处理blob URL\r\n  if (url.startsWith('blob:')) {\r\n    return url.replace('blob:', '');\r\n  }\r\n  \r\n  // 处理base64数据\r\n  if (url.startsWith('data:')) {\r\n    const matches = url.match(/^data:(.+?);base64,(.+)$/);\r\n    if (!matches || matches.length < 3) {\r\n      throw new Error('无效的base64数据');\r\n    }\r\n    \r\n    const [_, mimeType, base64Data] = matches;\r\n    const ext = mimeType.split('/')[1] || 'bin';\r\n    const tempPath = path.join(\r\n      app.getPath('temp'), \r\n      `temp-${Date.now()}.${ext}`\r\n    );\r\n    \r\n    fs.writeFileSync(tempPath, Buffer.from(base64Data, 'base64'));\r\n    return tempPath;\r\n  }\r\n  \r\n  // 普通文件路径\r\n  return path.normalize(url);\r\n}\r\n\r\nexport function timeToSeconds(time: string): number {\r\n  const parts = time.split(':');\r\n  return parseFloat(parts[0]) * 3600 + \r\n         parseFloat(parts[1]) * 60 + \r\n         parseFloat(parts[2]);\r\n}\r\n\r\n// 修正路径编码（如果乱码）\r\nexport function correctPath(rawPath: string) {\r\n  try {\r\n    // 尝试用GBK解码常见乱码\r\n    const gbkDecoded = iconv.decode(Buffer.from(rawPath, 'binary'), 'gbk');\r\n    \r\n    // 处理特殊乱码情况（如\"瀣э拷\"）\r\n    if (/[^\\u0000-\\uFFFF]/.test(gbkDecoded)) {\r\n      return rawPath.split(path.sep)\r\n        .map(segment => {\r\n          try {\r\n            return iconv.decode(Buffer.from(segment, 'binary'), 'gbk');\r\n          } catch {\r\n            return segment;\r\n          }\r\n        })\r\n        .join(path.sep);\r\n    }\r\n    return gbkDecoded;\r\n  } catch {\r\n    return rawPath; // 解码失败返回原路径\r\n  }\r\n};\r\n\r\n/**\r\n * 验证文件是否存在（自动处理编码问题）\r\n */\r\nexport async function validateFile(filePath: string) {\r\n  const correctedPath = correctPath(filePath);\r\n  const normalizedPath = path.normalize(correctedPath);\r\n  console.log(normalizedPath);\r\n\r\n  if (!fs.existsSync(normalizedPath)) {\r\n    // 尝试原始路径（某些情况下可能需要）\r\n    if (filePath !== normalizedPath && fs.existsSync(filePath)) {\r\n      return filePath;\r\n    }\r\n    throw new Error(`文件不存在: ${normalizedPath}\\n原始路径: ${filePath}`);\r\n  }\r\n  return normalizedPath;\r\n}\r\n\r\nexport const sleep = (waitTimeInMs: number) => new Promise(resolve => setTimeout(resolve, waitTimeInMs))\r\n\r\nexport function encodeArg(args: string) {\r\n  return Buffer.from(args).toString('base64');\r\n}\r\n\r\nexport function decodeArg(args: string) {\r\n  return Buffer.from(args, 'base64').toString('utf-8');\r\n}\r\n\r\n// 辅助函数：根据文件扩展名获取MIME类型\r\nexport function getMimeType(filePath: string): string {\r\n  const ext = path.extname(filePath).toLowerCase();\r\n  switch (ext) {\r\n    case '.mp4': return 'video/mp4';\r\n    case '.webm': return 'video/webm';\r\n    case '.mov': return 'video/quicktime';\r\n    case '.avi': return 'video/x-msvideo';\r\n    case '.mkv': return 'video/x-matroska';\r\n    case '.mp3': return 'audio/mpeg';\r\n    case '.wav': return 'audio/wav';\r\n    case '.ogg': return 'audio/ogg';\r\n    case '.aac': return 'audio/aac';\r\n    case '.flac': return 'audio/flac';\r\n    case '.jpg':\r\n    case '.jpeg': return 'image/jpeg';\r\n    case '.png': return 'image/png';\r\n    default: return 'application/octet-stream';\r\n  }\r\n}\r\n\r\nexport function createWebReadableStream(fileStream: fs.ReadStream): ReadableStream {\r\n  return new ReadableStream({\r\n    start(controller) {\r\n      fileStream.on('data', (chunk: Buffer) => {\r\n        controller.enqueue(chunk);\r\n      });\r\n      fileStream.on('end', () => {\r\n        controller.close();\r\n      });\r\n      fileStream.on('error', (err: Error) => {\r\n        controller.error(err);\r\n      });\r\n    },\r\n    cancel() {\r\n      fileStream.destroy();\r\n    }\r\n  });\r\n}\r\nexport function escapedFilePath(filePath: string) {\r\n  // Windows 路径需要特殊处理\r\n  if (process.platform === 'win32') {\r\n    // 替换反斜杠为双反斜杠，并转义冒号\r\n    return filePath\r\n      .replace(/\\\\/g, '\\\\\\\\')  // 反斜杠转义\r\n      .replace(/:/g, '\\\\:');   // 冒号转义\r\n  }\r\n  // Linux/macOS 只需处理空格等特殊字符\r\n  return filePath.replace(/(\\s)/g, '\\\\$1');\r\n}\r\n","// All of the Node.js APIs are available in the preload process.\r\n// It has the same sandbox as a Chrome extension.\r\nimport { contextBridge, ipcRenderer } from 'electron'\r\nimport { encodeArg } from './utils';\r\nimport crypto from 'crypto';\r\nimport fs from 'fs';\r\n\r\nwindow.addEventListener('DOMContentLoaded', () => {\r\n  const replaceText = (selector: string, text: string) => {\r\n    const element = document.getElementById(selector)\r\n    if (element) element.innerText = text\r\n  }\r\n\r\n  for (const type of ['chrome', 'node', 'electron']) {\r\n    replaceText(`${type}-version`, process.versions[type] as string)\r\n  }\r\n}) \r\n\r\ncontextBridge.exposeInMainWorld('electronCrypto', {\r\n  getRandomValues: (buffer: ArrayBufferView) => {\r\n    return crypto.getRandomValues(buffer)\r\n  },\r\n  randomUUID: () => crypto.randomUUID()\r\n})\r\n\r\ncontextBridge.exposeInMainWorld('electronAPI', {\r\n  saveVideo: (arrayBuffer: ArrayBuffer) => \r\n    ipcRenderer.invoke('save-video-blob', arrayBuffer),\r\n  \r\n  removeAllListeners: (channel: string): void => {\r\n    ipcRenderer.removeAllListeners(channel)\r\n  },\r\n  showSaveDialog: (options: any) => ipcRenderer.invoke('show-save-dialog', options),\r\n  selectDirectory: (options: any) => ipcRenderer.invoke('select-directory', options && encodeArg(JSON.stringify(options))),\r\n  openFile: (path: string) => ipcRenderer.invoke('open-file', path),\r\n\r\n  getDefaultSavePath: () => ipcRenderer.invoke('get-default-save-path'),\r\n\r\n  text2voice: (params: any) => ipcRenderer.invoke('text2voice', encodeArg(JSON.stringify(params))),\r\n\r\n  videoMixAndCut: (params: any) => ipcRenderer.invoke('video-mix-and-cut', encodeArg(JSON.stringify(params))),\r\n\r\n  openFileDialog: (options: any) => ipcRenderer.invoke('open-file-dialog', options),\r\n\r\n  getMediaDuration: (path: string) => ipcRenderer.invoke('get-media-duration', encodeArg(JSON.stringify({\r\n    path\r\n  }))),\r\n\r\n  readFile: (filePath: string) => {\r\n    return new Promise((resolve, reject) => {\r\n      fs.readFile(filePath, (err, data) => {\r\n        if (err) reject(err);\r\n        else resolve(data);\r\n      });\r\n    });\r\n  },\r\n\r\n  readFileBase64: (filePath: string) => {\r\n    return new Promise((resolve, reject) => {\r\n      fs.readFile(filePath, (err, data) => {\r\n        if (err) reject(err);\r\n        resolve(Buffer.from(data).toString('base64'));\r\n      });\r\n    });\r\n  },\r\n});"],"names":["encodeArg","args","replaceText","selector","text","element","type","contextBridge","buffer","crypto","arrayBuffer","ipcRenderer","channel","options","path","params","filePath","resolve","reject","fs","err","data"],"mappings":"mGACc,QAAQ,YAAY,EAuF3B,SAASA,EAAUC,EAAc,CACtC,OAAO,OAAO,KAAKA,CAAI,EAAE,SAAS,QAAQ,CAC5C,CCnFA,OAAO,iBAAiB,mBAAoB,IAAM,CAC1C,MAAAC,EAAc,CAACC,EAAkBC,IAAiB,CAChD,MAAAC,EAAU,SAAS,eAAeF,CAAQ,EAC5CE,IAASA,EAAQ,UAAYD,EAAA,EAGnC,UAAWE,IAAQ,CAAC,SAAU,OAAQ,UAAU,EAC9CJ,EAAY,GAAGI,CAAI,WAAY,QAAQ,SAASA,CAAI,CAAW,CAEnE,CAAC,EAEDC,EAAAA,cAAc,kBAAkB,iBAAkB,CAChD,gBAAkBC,GACTC,EAAO,gBAAgBD,CAAM,EAEtC,WAAY,IAAMC,EAAO,WAAW,CACtC,CAAC,EAEDF,EAAAA,cAAc,kBAAkB,cAAe,CAC7C,UAAYG,GACVC,EAAAA,YAAY,OAAO,kBAAmBD,CAAW,EAEnD,mBAAqBE,GAA0B,CAC7CD,cAAY,mBAAmBC,CAAO,CACxC,EACA,eAAiBC,GAAiBF,EAAAA,YAAY,OAAO,mBAAoBE,CAAO,EAChF,gBAAkBA,GAAiBF,EAAA,YAAY,OAAO,mBAAoBE,GAAWb,EAAU,KAAK,UAAUa,CAAO,CAAC,CAAC,EACvH,SAAWC,GAAiBH,EAAAA,YAAY,OAAO,YAAaG,CAAI,EAEhE,mBAAoB,IAAMH,EAAAA,YAAY,OAAO,uBAAuB,EAEpE,WAAaI,GAAgBJ,EAAY,YAAA,OAAO,aAAcX,EAAU,KAAK,UAAUe,CAAM,CAAC,CAAC,EAE/F,eAAiBA,GAAgBJ,EAAY,YAAA,OAAO,oBAAqBX,EAAU,KAAK,UAAUe,CAAM,CAAC,CAAC,EAE1G,eAAiBF,GAAiBF,EAAAA,YAAY,OAAO,mBAAoBE,CAAO,EAEhF,iBAAmBC,GAAiBH,cAAY,OAAO,qBAAsBX,EAAU,KAAK,UAAU,CACpG,KAAAc,CACD,CAAA,CAAC,CAAC,EAEH,SAAWE,GACF,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtCC,EAAG,SAASH,EAAU,CAACI,EAAKC,IAAS,CAC/BD,EAAKF,EAAOE,CAAG,EACdH,EAAQI,CAAI,CAAA,CAClB,CAAA,CACF,EAGH,eAAiBL,GACR,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtCC,EAAG,SAASH,EAAU,CAACI,EAAKC,IAAS,CAC/BD,GAAKF,EAAOE,CAAG,EACnBH,EAAQ,OAAO,KAAKI,CAAI,EAAE,SAAS,QAAQ,CAAC,CAAA,CAC7C,CAAA,CACF,CAEL,CAAC"}